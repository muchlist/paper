<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pay Attention to These Things When Using Golang Goroutines | Muchlis Dev</title><meta name=keywords content="Golang,Goroutine,Context Management,Error Handling,Graceful Shutdown,Best Practices"><meta name=description content="Effective ways to avoid mistakes that can occur when using goroutines."><meta name=author content="Muchlis at eFishery"><link rel=canonical href=https://blog.muchlis.dev/en/post/safe-goroutine/><meta name=google-site-verification content="G-F1ZZCKLSJF"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.muchlis.dev/icon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.muchlis.dev/icon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.muchlis.dev/icon/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.muchlis.dev/icon/apple-touch-icon.png><link rel=mask-icon href=https://blog.muchlis.dev/icon/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=id href=https://blog.muchlis.dev/post/safe-goroutine/><link rel=alternate hreflang=en href=https://blog.muchlis.dev/en/post/safe-goroutine/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-F1ZZCKLSJF"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F1ZZCKLSJF")}</script><meta property="og:url" content="https://blog.muchlis.dev/en/post/safe-goroutine/"><meta property="og:site_name" content="Muchlis Dev"><meta property="og:title" content="Pay Attention to These Things When Using Golang Goroutines"><meta property="og:description" content="Effective ways to avoid mistakes that can occur when using goroutines."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-26T11:30:03+00:00"><meta property="article:modified_time" content="2022-12-26T11:30:03+00:00"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Goroutine"><meta property="article:tag" content="Context Management"><meta property="article:tag" content="Error Handling"><meta property="article:tag" content="Graceful Shutdown"><meta property="article:tag" content="Best Practices"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pay Attention to These Things When Using Golang Goroutines"><meta name=twitter:description content="Effective ways to avoid mistakes that can occur when using goroutines."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.muchlis.dev/en/post/"},{"@type":"ListItem","position":2,"name":"Pay Attention to These Things When Using Golang Goroutines","item":"https://blog.muchlis.dev/en/post/safe-goroutine/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pay Attention to These Things When Using Golang Goroutines","name":"Pay Attention to These Things When Using Golang Goroutines","description":"Effective ways to avoid mistakes that can occur when using goroutines.","keywords":["Golang","Goroutine","Context Management","Error Handling","Graceful Shutdown","Best Practices"],"articleBody":"In backend development with Golang, managing background processes using goroutines is a common practice that can improve application performance. However, there are several common problems often encountered when implementing goroutines, especially regarding panic handling, context management, and proper shutdown processes. This article will review some common mistakes related to goroutine usage and how to overcome them.\nCommon Problems in Goroutine Usage Panics inside sub goroutines are not included in the main goroutine’s recovery area. Context passed to goroutines can be subject to deadline or cancellation when the main goroutine finishes execution. Graceful shutdown can still ignore background processes that are being processed. 1. Handling Panic Inside Sub Goroutines Many developers assume that panics in all code in HTTP services will be recovered by recovery middleware. However, panic recovery only applies to one goroutine. If we call another goroutine, we need additional recovery code. Here’s an example:\nfunc main() { // panic recovery for main program defer func() { if err := recover(); err != nil { fmt.Printf(\"panic recovered: %s\", err) } }() go func() { // panic recovery for sub goroutine defer func() { if err := recover(); err != nil { fmt.Printf(\"panic recovered: %s\", err) } }() // Running in background publish(context.Background(), response) }() ... } To make it easier, we can create a helper function as follows:\nfunc Background(fn func()) { go func() { defer func() { if err := recover(); err != nil { fmt.Printf(\"panic recovered: %s\", err) } }() fn() }() } Using this helper function, the previous example code can be changed to:\nfunc main() { // panic recovery for main program defer func() { if err := recover(); err != nil { fmt.Printf(\"panic recovered: %s\", err) } }() Background(func() { publish(context.Background(), response) }) ... } 2. Managing Context in Goroutines Context is always used in Golang programs to pass important data such as tracing identification, request_id, and for process canceling needs. However, context passed to goroutines can cause problems, especially if the context finishes faster than the goroutine. For example, context from HTTP requests is passed to functions running in different goroutines. If that context finishes, then the process in the goroutine will be canceled if it’s aware of context cancellation.\nExample:\nfunc SampleHandler(w http.ResponseWriter, r *http.Request) { response, err := doSomeTask(r.Context(), r) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } go func() { // suppose publish takes 2 seconds // and is aware of context status err := publish(r.Context(), response) }() // SampleHandler finishes in 1 second ... } With the above example, publish will fail and get a context canceled error. To overcome this, we can replace r.Context() with context.Background(). However, what if we need values inside the context? The solution is to create our own context implementation:\ntype Detach struct { ctx context.Context } func (d Detach) Deadline() (time.Time, bool) { return time.Time{}, false } // done signal will be ignored func (d Detach) Done() \u003c-chan struct{} { return nil } func (d Detach) Err() error { return nil } func (d Detach) Value(key any) any { return d.ctx.Value(key) } Using this custom context, cancellation signals from the parent context will have no effect, while other values remain the same. Here’s its application to the previous example:\nfunc SampleHandler(w http.ResponseWriter, r *http.Request) { response, err := doSomeTask(r.Context(), r) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } go func() { // suppose publish takes 2 seconds // publish will continue even if it takes longer than main func err := publish(Detach{ctx: r.Context()}, response) }() // SampleHandler finishes in 1 second ... } 3. Performing Graceful Shutdown with Goroutines Graceful shutdown is the process of waiting for all processes to finish before the application is completely stopped. In HTTP servers, the steps are usually as follows:\nGet application terminate signal. Close HTTP server so no requests come in. Wait for all processes in one request-response cycle to finish. Close all database connections. However, what about processes still running in goroutines? If the process is important (for example invalidate cache), we can use sync.WaitGroup to detect if there are still unfinished processes. Here’s example code using sync.WaitGroup:\nimport ( \"context\" \"fmt\" \"sync\" ) // wgProcess waitgroup for gracefully shutdown background process var wgProcess sync.WaitGroup func Background(fn func()) { wgProcess.Add(1) go func() { defer wgProcess.Done() defer func() { if err := recover(); err != nil { log.Error(fmt.Sprintf(\"panic when run background process\"), fmt.Errorf(\"%s\", err)) } }() fn() }() } This code ensures that all Background processes are recorded for start and completion through waitgroup. In the main program that implements Graceful Shutdown, we add wgProcess.Wait() so the process blocks until the waitgroup is 0 (when all processes finish running). Make sure that functions adding sync.WaitGroup can stop, or add timeout.\nBy understanding and implementing the solutions above, you can manage background processes more effectively in Golang. Always make sure to handle panic in every goroutine, manage context properly, and perform application shutdown properly so all processes can finish correctly.\n","wordCount":"827","inLanguage":"en","datePublished":"2022-12-26T11:30:03Z","dateModified":"2022-12-26T11:30:03Z","author":{"@type":"Person","name":"Muchlis at eFishery"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.muchlis.dev/en/post/safe-goroutine/"},"publisher":{"@type":"Organization","name":"Muchlis Dev","logo":{"@type":"ImageObject","url":"https://blog.muchlis.dev/icon/favicon.ico"}}}</script><link rel=stylesheet href=https://blog.muchlis.dev/css/custom-styles.min.846e2c0c38b3403ffecfec3d9c9b227dcfa79e75b178a91e1a26ae745cf5da5a.css><script src=https://blog.muchlis.dev/js/clickable-image.min.64e4ed1fd2302afde6a6750edcf663d18d6bf3b36d95ac130501827d8732c7a3.js defer></script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.muchlis.dev/en/ accesskey=h title="Home (Alt + H)"><img src=https://blog.muchlis.dev/icon/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.muchlis.dev/ title=Indonesian aria-label=Indonesian>Id</a></li></ul></div></div><ul id=menu><li><a href=https://blog.muchlis.dev/en/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://blog.muchlis.dev/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.muchlis.dev/en/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://muchlis.dev title="Portfolio (2021)"><span>Portfolio (2021)</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.muchlis.dev/en/>Home</a>&nbsp;»&nbsp;<a href=https://blog.muchlis.dev/en/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Pay Attention to These Things When Using Golang Goroutines</h1><div class=post-description>Effective ways to avoid mistakes that can occur when using goroutines.</div><div class=post-meta><span title='2022-12-26 11:30:03 +0000 +0000'>December 26, 2022</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;827 words&nbsp;·&nbsp;Muchlis at eFishery&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://blog.muchlis.dev/post/safe-goroutine/>Id</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/muchlist/paper/tree/main/content/post/safe-goroutine.en.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#common-problems-in-goroutine-usage>Common Problems in Goroutine Usage</a><ul><li><a href=#1-handling-panic-inside-sub-goroutines>1. Handling Panic Inside Sub Goroutines</a></li><li><a href=#2-managing-context-in-goroutines>2. Managing Context in Goroutines</a></li><li><a href=#3-performing-graceful-shutdown-with-goroutines>3. Performing Graceful Shutdown with Goroutines</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>In backend development with Golang, managing background processes using goroutines is a common practice that can improve application performance. However, there are several common problems often encountered when implementing goroutines, especially regarding panic handling, context management, and proper shutdown processes. This article will review some common mistakes related to goroutine usage and how to overcome them.</p><h2 id=common-problems-in-goroutine-usage>Common Problems in Goroutine Usage<a hidden class=anchor aria-hidden=true href=#common-problems-in-goroutine-usage>#</a></h2><ol><li>Panics inside sub goroutines are not included in the main goroutine&rsquo;s recovery area.</li><li>Context passed to goroutines can be subject to deadline or cancellation when the main goroutine finishes execution.</li><li>Graceful shutdown can still ignore background processes that are being processed.</li></ol><h3 id=1-handling-panic-inside-sub-goroutines>1. Handling Panic Inside Sub Goroutines<a hidden class=anchor aria-hidden=true href=#1-handling-panic-inside-sub-goroutines>#</a></h3><p>Many developers assume that panics in all code in HTTP services will be recovered by recovery middleware. However, panic recovery only applies to one goroutine. If we call another goroutine, we need additional recovery code. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// panic recovery for main program</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;panic recovered: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// panic recovery for sub goroutine</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;panic recovered: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Running in background</span>
</span></span><span class=line><span class=cl>        <span class=nf>publish</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>To make it easier, we can create a helper function as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Background</span><span class=p>(</span><span class=nx>fn</span> <span class=kd>func</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;panic recovered: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>fn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Using this helper function, the previous example code can be changed to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// panic recovery for main program</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;panic recovered: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>Background</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>publish</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=2-managing-context-in-goroutines>2. Managing Context in Goroutines<a hidden class=anchor aria-hidden=true href=#2-managing-context-in-goroutines>#</a></h3><p>Context is always used in Golang programs to pass important data such as tracing identification, request_id, and for process canceling needs. However, context passed to goroutines can cause problems, especially if the context finishes faster than the goroutine. For example, context from HTTP requests is passed to functions running in different goroutines. If that context finishes, then the process in the goroutine will be canceled if it&rsquo;s aware of context cancellation.</p><p>Example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>SampleHandler</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>doSomeTask</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// suppose publish takes 2 seconds</span>
</span></span><span class=line><span class=cl>        <span class=c1>// and is aware of context status</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nf>publish</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// SampleHandler finishes in 1 second</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>With the above example, publish will fail and get a context canceled error. To overcome this, we can replace <code>r.Context()</code> with <code>context.Background()</code>. However, what if we need values inside the <code>context</code>? The solution is to create our own context implementation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Detach</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=nx>Detach</span><span class=p>)</span> <span class=nf>Deadline</span><span class=p>()</span> <span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// done signal will be ignored</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=nx>Detach</span><span class=p>)</span> <span class=nf>Done</span><span class=p>()</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=nx>Detach</span><span class=p>)</span> <span class=nf>Err</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=nx>Detach</span><span class=p>)</span> <span class=nf>Value</span><span class=p>(</span><span class=nx>key</span> <span class=kt>any</span><span class=p>)</span> <span class=kt>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>d</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Using this custom context, cancellation signals from the parent context will have no effect, while other values remain the same. Here&rsquo;s its application to the previous example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>SampleHandler</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>doSomeTask</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// suppose publish takes 2 seconds</span>
</span></span><span class=line><span class=cl>        <span class=c1>// publish will continue even if it takes longer than main func</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nf>publish</span><span class=p>(</span><span class=nx>Detach</span><span class=p>{</span><span class=nx>ctx</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()},</span> <span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// SampleHandler finishes in 1 second</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=3-performing-graceful-shutdown-with-goroutines>3. Performing Graceful Shutdown with Goroutines<a hidden class=anchor aria-hidden=true href=#3-performing-graceful-shutdown-with-goroutines>#</a></h3><p>Graceful shutdown is the process of waiting for all processes to finish before the application is completely stopped. In HTTP servers, the steps are usually as follows:</p><ol><li>Get application terminate signal.</li><li>Close HTTP server so no requests come in.</li><li>Wait for all processes in one request-response cycle to finish.</li><li>Close all database connections.</li></ol><p>However, what about processes still running in goroutines? If the process is important (for example invalidate cache), we can use <code>sync.WaitGroup</code> to detect if there are still unfinished processes. Here&rsquo;s example code using <code>sync.WaitGroup</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// wgProcess waitgroup for gracefully shutdown background process</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>wgProcess</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Background</span><span class=p>(</span><span class=nx>fn</span> <span class=kd>func</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>wgProcess</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nx>wgProcess</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;panic when run background process&#34;</span><span class=p>),</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>fn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This code ensures that all Background processes are recorded for start and completion through waitgroup. In the main program that implements Graceful Shutdown, we add <code>wgProcess.Wait()</code> so the process blocks until the waitgroup is 0 (when all processes finish running). Make sure that functions adding sync.WaitGroup can stop, or add timeout.</p><hr><p>By understanding and implementing the solutions above, you can manage background processes more effectively in Golang. Always make sure to handle panic in every goroutine, manage context properly, and perform application shutdown properly so all processes can finish correctly.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.muchlis.dev/en/tags/golang/>Golang</a></li><li><a href=https://blog.muchlis.dev/en/tags/goroutine/>Goroutine</a></li><li><a href=https://blog.muchlis.dev/en/tags/context-management/>Context Management</a></li><li><a href=https://blog.muchlis.dev/en/tags/error-handling/>Error Handling</a></li><li><a href=https://blog.muchlis.dev/en/tags/graceful-shutdown/>Graceful Shutdown</a></li><li><a href=https://blog.muchlis.dev/en/tags/best-practices/>Best Practices</a></li></ul><nav class=paginav><a class=prev href=https://blog.muchlis.dev/en/post/structuring-project-folder/><span class=title>« Prev</span><br><span>Folder Structure and Code Writing Rules in Golang Projects: Personal Preferences</span>
</a><a class=next href=https://blog.muchlis.dev/en/post/profiling/><span class=title>Next »</span><br><span>Profiling Techniques in Golang</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Pay Attention to These Things When Using Golang Goroutines on x" href="https://x.com/intent/tweet/?text=Pay%20Attention%20to%20These%20Things%20When%20Using%20Golang%20Goroutines&amp;url=https%3a%2f%2fblog.muchlis.dev%2fen%2fpost%2fsafe-goroutine%2f&amp;hashtags=Golang%2cGoroutine%2cContextManagement%2cErrorHandling%2cGracefulShutdown%2cBestPractices"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pay Attention to These Things When Using Golang Goroutines on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.muchlis.dev%2fen%2fpost%2fsafe-goroutine%2f&amp;title=Pay%20Attention%20to%20These%20Things%20When%20Using%20Golang%20Goroutines&amp;summary=Pay%20Attention%20to%20These%20Things%20When%20Using%20Golang%20Goroutines&amp;source=https%3a%2f%2fblog.muchlis.dev%2fen%2fpost%2fsafe-goroutine%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pay Attention to These Things When Using Golang Goroutines on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.muchlis.dev%2fen%2fpost%2fsafe-goroutine%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pay Attention to These Things When Using Golang Goroutines on whatsapp" href="https://api.whatsapp.com/send?text=Pay%20Attention%20to%20These%20Things%20When%20Using%20Golang%20Goroutines%20-%20https%3a%2f%2fblog.muchlis.dev%2fen%2fpost%2fsafe-goroutine%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pay Attention to These Things When Using Golang Goroutines on telegram" href="https://telegram.me/share/url?text=Pay%20Attention%20to%20These%20Things%20When%20Using%20Golang%20Goroutines&amp;url=https%3a%2f%2fblog.muchlis.dev%2fen%2fpost%2fsafe-goroutine%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=muchlist/paper data-repo-id=R_kgDOMD4syA data-category=General data-category-id=DIC_kwDOMD4syM4ChOKX data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=dark_dimmed data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.muchlis.dev/en/>Muchlis Dev</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>